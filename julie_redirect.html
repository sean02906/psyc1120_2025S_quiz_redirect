<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Access Verification</title>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BDS2MJC2XF"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-BDS2MJC2XF');
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        .message {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .error { color: #d32f2f; }
    </style>
</head>
<body>
    <div id="message" class="message">Verifying access...</div>
    <script>
        // *** CONFIGURATION - How long a QR code remains valid ***
        const VALID_WINDOW_MS = 30000; // 30 seconds

        function generateDeviceFingerprint() {
            // Collect device characteristics
            const components = [
                navigator.userAgent,
                screen.width,
                screen.height,
                screen.colorDepth,
                navigator.language,
                navigator.platform,
                new Date().getTimezoneOffset(),
                navigator.hardwareConcurrency,
                navigator.deviceMemory,
                navigator.maxTouchPoints,
                window.devicePixelRatio
            ].filter(Boolean); // Remove undefined values
            
            // Create a hash of the components
            let hash = 0;
            const str = components.join('|||');
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return Math.abs(hash).toString(36); // Convert to base-36 for shorter string
        }

        function generateToken() {
            // Get current time in milliseconds
            const timestamp = Date.now();
            
            // Get last 4 digits of timestamp
            const timeComponent = (timestamp % 10000).toString().padStart(4, '0');
            
            // Generate 4 random digits
            const randomComponent = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            
            // Combine for a unique 8-digit token
            return `${timeComponent}${randomComponent}`;
        }

        function getDeviceInfo() {
            return {
                userAgent: navigator.userAgent,
                screenResolution: `${screen.width}x${screen.height}`,
                colorDepth: screen.colorDepth,
                timezone: new Date().getTimezoneOffset(),
                language: navigator.language,
                platform: navigator.platform,
                cores: navigator.hardwareConcurrency || 'unknown',
                memory: navigator.deviceMemory || 'unknown',
                touchPoints: navigator.maxTouchPoints || 'unknown',
                pixelRatio: window.devicePixelRatio || 1
            };
        }

        function appendTokenToUrl(url) {
            const token = generateToken();
            const deviceId = generateDeviceFingerprint();
            const tokenFieldId = 'entry.792201317'; // Your Google Form field ID
            
            // Parse the existing URL
            const urlObj = new URL(decodeURIComponent(url));
            
            // Add the token parameter
            urlObj.searchParams.append(tokenFieldId, token);

            // Get detailed device info for analytics
            const deviceInfo = getDeviceInfo();
            
            // Log comprehensive attendance event to Google Analytics
            gtag('event', 'attendance_redirect', {
                'event_category': 'attendance',
                'event_label': token,
                'attendance_token': token,
                'device_fingerprint': deviceId,
                'redirect_url': urlObj.toString(),
                'device_user_agent': deviceInfo.userAgent,
                'device_screen': deviceInfo.screenResolution,
                'device_color_depth': deviceInfo.colorDepth,
                'device_timezone': deviceInfo.timezone,
                'device_language': deviceInfo.language,
                'device_platform': deviceInfo.platform,
                'device_cores': deviceInfo.cores,
                'device_memory': deviceInfo.memory,
                'device_touch_points': deviceInfo.touchPoints,
                'device_pixel_ratio': deviceInfo.pixelRatio,
                'timestamp': Date.now()
            });
            
            return urlObj.toString();
        }

        function validateAccess() {
            try {
                const params = new URLSearchParams(window.location.search);
                const timestamp = parseInt(params.get('t'));
                const quizUrl = params.get('url');
                
                if (!quizUrl || !timestamp) {
                    throw new Error('Invalid parameters');
                }
                const now = Date.now();
                const age = now - timestamp;
                
                if (age >= 0 && age < VALID_WINDOW_MS) {
                    // Log successful validation with device info
                    gtag('event', 'redirect', {
                        'event_category': 'quiz_access',
                        'event_label': 'successful_validation',
                        'device_fingerprint': generateDeviceFingerprint(),
                        'validation_age_ms': age,
                        ...getDeviceInfo()
                    });
                    
                    // Add token and redirect
                    const urlWithToken = appendTokenToUrl(quizUrl);
                    window.location.href = urlWithToken;
                } else {
                    // Log expired code attempt
                    gtag('event', 'expired_code', {
                        'event_category': 'quiz_access',
                        'event_label': 'code_expired',
                        'value': Math.floor(age / 1000), // age in seconds
                        'device_fingerprint': generateDeviceFingerprint(),
                        ...getDeviceInfo()
                    });
                    document.getElementById('message').textContent = "Access code has expired. Please scan the current code.";
                    document.getElementById('message').classList.add('error');
                }
            } catch (error) {
                // Log invalid access attempt
                gtag('event', 'invalid_code', {
                    'event_category': 'quiz_access',
                    'event_label': 'invalid_parameters',
                    'device_fingerprint': generateDeviceFingerprint(),
                    ...getDeviceInfo()
                });
                document.getElementById('message').textContent = "Invalid access code.";
                document.getElementById('message').classList.add('error');
            }
        }
        validateAccess();
    </script>
</body>
</html>
